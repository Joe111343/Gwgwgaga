<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>多人 17 關節 + 麥克風 P2P</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
body{ margin:0; background:#111; color:#fff; font-family:sans-serif; }
#canvas{ width:100vw; height:100vh; display:block; background:#000; }
#controls{ position:fixed; top:10px; left:10px; background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; }
input, button{ margin:4px; }
</style>
</head>
<body>
<div id="controls">
  <div>你的ID: <span id="myId">...</span></div>
  <input type="text" id="peerId" placeholder="輸入對方ID">
  <button id="connectBtn">連線</button>
</div>
<canvas id="canvas"></canvas>
<video id="video" autoplay playsinline style="display:none;"></video>

<script>
(async()=>{
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // 初始化攝影機 + 麥克風
  const stream = await navigator.mediaDevices.getUserMedia({video:{width:720,height:540}, audio:true});
  video.srcObject = stream;
  await new Promise(r=>video.onloadedmetadata=r);
  video.play();
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  // MoveNet MULTIPOSE
  const detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING }
  );

  // skeletal settings
  const KP_NAMES = ['nose','left_eye','right_eye','left_ear','right_ear','left_shoulder','right_shoulder','left_elbow','right_elbow','left_wrist','right_wrist','left_hip','right_hip','left_knee','right_knee','left_ankle','right_ankle'];
  const SKELETON = [[0,5],[0,6],[5,6],[5,7],[7,9],[6,8],[8,10],[11,12],[5,11],[6,12],[11,13],[13,15],[12,14],[14,16],[1,0],[2,0],[1,3],[2,4]];
  const COLORS = ['#06d6a0','#118ab2','#ef476f','#ffd166','#a78bfa','#ffa8a8','#8ecae6','#fb8500'];

  function drawPersons(persons){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=0;i<persons.length;i++){
      ctx.strokeStyle=COLORS[i%COLORS.length]; ctx.lineWidth=3;
      for(const [a,b] of SKELETON){
        const p1=persons[i][a],p2=persons[i][b];
        if(!p1||!p2) continue;
        if(p1.score<0.35||p2.score<0.35) continue;
        ctx.beginPath();
        ctx.moveTo(p1.x,p1.y);
        ctx.lineTo(p2.x,p2.y);
        ctx.stroke();
      }
      for(const k of persons[i]){
        if(k.score<0.35) continue;
        ctx.fillStyle=COLORS[i%COLORS.length];
        ctx.beginPath();
        ctx.arc(k.x,k.y,5,0,Math.PI*2);
        ctx.fill();
      }
    }
  }

  // 產生短ID
  function shortId(){ return Math.floor(Math.random()*9000)+1000+''; }
  const myPeerId = shortId();

  // PeerJS 初始化
  const peer = new Peer(myPeerId);
  const myIdSpan = document.getElementById('myId');
  const connectBtn = document.getElementById('connectBtn');
  const peerInput = document.getElementById('peerId');
  let conn=null;
  myIdSpan.textContent = myPeerId;

  peer.on('connection', c=>{
    conn = c;
    conn.on('data', data=>{ drawPersons(data); });
  });

  peer.on('call', call=>{
    call.answer(stream); // 回傳自己的音訊/影像
    call.on('stream', remoteStream=>{
      let audio = document.createElement('audio');
      audio.srcObject = remoteStream;
      audio.autoplay=true; audio.play();
    });
  });

  connectBtn.onclick=()=>{
    const target = peerInput.value.trim();
    if(!target) return alert('請輸入對方ID');
    conn = peer.connect(target);
    conn.on('open', ()=>{
      console.log('已連線到',target);
      // 呼叫對方音訊
      const call = peer.call(target, stream);
      call.on('stream', remoteStream=>{
        let audio = document.createElement('audio');
        audio.srcObject = remoteStream;
        audio.autoplay=true; audio.play();
      });
    });
    conn.on('data', data=>{ drawPersons(data); });
  };

  // main loop
  async function loop(){
    const poses = await detector.estimatePoses(video);
    const persons = poses.map(p=>p.keypoints.map(k=>({x:k.x,y:k.y,score:k.score})));
    drawPersons(persons);
    if(conn && conn.open) try{ conn.send(persons); }catch(e){console.log(e);}
    requestAnimationFrame(loop);
  }
  loop();

})();
</script>
</body>
</html>